name: ravikoodi
title: Ravikoodi content server
adopt-info: ravikoodi
#version: 1.1.11
summary: Small server to broadcast local media content to KODI Media Player
description: Small server to broadcast local media content to KODI Media Player
license: Apache-2.0
grade: stable
base: core24
confinement: strict
platforms:
  amd64:
  arm64:
  armhf:
  riscv64:

lint:
  ignore:
    - library:
        - usr/lib/jvm/*java*-*/lib/*.so
        - '**/libX*.so.*'
        - '**/libxcb.so.*'
        - '**/libfontconfig.so.*'
        - '**/liboss4-salsa.so.*'

package-repositories:
  - type: apt
    components: [main]
    suites: [stable]
    key-id: 99A5C88E3C5B1FA8B05A19D332E9750179FCEA62
    url: https://apt.bell-sw.com/

apps:
  ravikoodi:
    environment:
      JAVA_HOME: $SNAP/usr/lib/jvm/java-21-openjdk-$SNAP_ARCH
      PATH: $JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH
      #DISABLE_WAYLAND: 1
    command: usr/bin/ravikoodi
    desktop: ravikoodi.desktop
    plugs:
      [home, network, network-bind, desktop, x11]

parts:
  launcher:
      plugin: dump
      source: snap/bin
      source-type: local
      organize:
        ravikoodi-launcher: usr/bin/ravikoodi

  ravikoodi:
    plugin: maven
    source: https://github.com/skaba/ravikoodi-server.git
    source-tag: snap
    source-type: git
    maven-parameters:
      [-f ravikoodi-app/pom.xml -DskipTests]

    override-pull: |
     craftctl default
     craftctl set version=$(mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.version | sed -n -e '/^\[.*\]/ !{ /^[0-9]/ { p; q } }')-$(git rev-parse --short HEAD)

    build-packages:
      [openjdk-21-jdk, maven]

    override-build: |
      craftctl default
      mv $CRAFT_PART_INSTALL/jar/ravikoodi-app-*.jar $CRAFT_PART_INSTALL/jar/ravikoodi.jar
      cp ravikoodi.desktop $CRAFT_PART_INSTALL/
      cp ravikoodi-logo-1024.png $CRAFT_PART_INSTALL/

    stage-packages:
      [openjdk-21-jre]
